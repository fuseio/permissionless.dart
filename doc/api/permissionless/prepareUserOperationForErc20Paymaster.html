<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=no">
  <meta name="description" content="API docs for the prepareUserOperationForErc20Paymaster function from the permissionless library, for the Dart programming language.">
  <title>prepareUserOperationForErc20Paymaster function - permissionless library - Dart API</title>


  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  
  <link rel="stylesheet" href="../static-assets/github.css?v1">
  <link rel="stylesheet" href="../static-assets/styles.css?v1">
  <link rel="icon" href="../static-assets/favicon.png?v1">
  
</head>

<body data-base-href="../" data-using-base-href="false" class="light-theme">
<div id="overlay-under-drawer"></div>
<header id="title">
  <span id="sidenav-left-toggle" class="material-symbols-outlined" role="button" tabindex="0">menu</span>
  <ol class="breadcrumbs gt-separated dark hidden-xs">
    <li><a href="../index.html">permissionless</a></li>
    <li><a href="../permissionless/">permissionless.dart</a></li>
    <li class="self-crumb">prepareUserOperationForErc20Paymaster function</li>
  </ol>
  <div class="self-name">prepareUserOperationForErc20Paymaster</div>
  <form class="search navbar-right" role="search">
    <input type="text" id="search-box" autocomplete="off" disabled class="form-control typeahead" placeholder="Loading search...">
  </form>
  <button class="toggle" id="theme-button" title="Toggle between light and dark mode" aria-label="Light and dark mode toggle">
    <span id="dark-theme-button" class="material-symbols-outlined" aria-hidden="true">
      dark_mode
    </span>
    <span id="light-theme-button" class="material-symbols-outlined" aria-hidden="true">
      light_mode
    </span>
  </button>
</header>
<main>
  <div
      id="dartdoc-main-content"
      class="main-content"
      data-above-sidebar="permissionless&#47;permissionless-library-sidebar.html"
      data-below-sidebar="">
      <div>
<h1><span class="kind-function">prepareUserOperationForErc20Paymaster</span> function 
 
</h1></div>

    <section class="multi-line-signature">
        
<span class="returntype"><a href="https://api.dart.dev/stable/3.10.4/dart-core/Future-class.html">Future</a><span class="signature">&lt;<wbr><span class="type-parameter"><a href="../permissionless/Erc20PaymasterResult-class.html">Erc20PaymasterResult</a></span>&gt;</span></span>
<span class="name ">prepareUserOperationForErc20Paymaster</span>(<wbr>{<ol class="parameter-list"> <li><span class="parameter" id="prepareUserOperationForErc20Paymaster-param-smartAccountClient"><span>required</span> <span class="type-annotation"><a href="../permissionless/SmartAccountClient-class.html">SmartAccountClient</a></span> <span class="parameter-name">smartAccountClient</span>, </span></li>
<li><span class="parameter" id="prepareUserOperationForErc20Paymaster-param-pimlicoClient"><span>required</span> <span class="type-annotation"><a href="../permissionless/PimlicoClient-class.html">PimlicoClient</a></span> <span class="parameter-name">pimlicoClient</span>, </span></li>
<li><span class="parameter" id="prepareUserOperationForErc20Paymaster-param-publicClient"><span>required</span> <span class="type-annotation"><a href="../permissionless/PublicClient-class.html">PublicClient</a></span> <span class="parameter-name">publicClient</span>, </span></li>
<li><span class="parameter" id="prepareUserOperationForErc20Paymaster-param-token"><span>required</span> <span class="type-annotation"><a href="https://pub.dev/documentation/wallet/0.0.18/wallet/EthereumAddress-class.html">EthereumAddress</a></span> <span class="parameter-name">token</span>, </span></li>
<li><span class="parameter" id="prepareUserOperationForErc20Paymaster-param-calls"><span>required</span> <span class="type-annotation"><a href="https://api.dart.dev/stable/3.10.4/dart-core/List-class.html">List</a><span class="signature">&lt;<wbr><span class="type-parameter"><a href="../permissionless/Call-class.html">Call</a></span>&gt;</span></span> <span class="parameter-name">calls</span>, </span></li>
<li><span class="parameter" id="prepareUserOperationForErc20Paymaster-param-maxFeePerGas"><span>required</span> <span class="type-annotation"><a href="https://api.dart.dev/stable/3.10.4/dart-core/BigInt-class.html">BigInt</a></span> <span class="parameter-name">maxFeePerGas</span>, </span></li>
<li><span class="parameter" id="prepareUserOperationForErc20Paymaster-param-maxPriorityFeePerGas"><span>required</span> <span class="type-annotation"><a href="https://api.dart.dev/stable/3.10.4/dart-core/BigInt-class.html">BigInt</a></span> <span class="parameter-name">maxPriorityFeePerGas</span>, </span></li>
<li><span class="parameter" id="prepareUserOperationForErc20Paymaster-param-nonce"><span class="type-annotation"><a href="https://api.dart.dev/stable/3.10.4/dart-core/BigInt-class.html">BigInt</a>?</span> <span class="parameter-name">nonce</span>, </span></li>
<li><span class="parameter" id="prepareUserOperationForErc20Paymaster-param-config"><span class="type-annotation"><a href="../permissionless/Erc20PaymasterConfig-class.html">Erc20PaymasterConfig</a></span> <span class="parameter-name">config</span> = <span class="default-value">const Erc20PaymasterConfig()</span>, </span></li>
</ol>})

        

    </section>
    
<section class="desc markdown">
  <p>Prepares a UserOperation for ERC-20 paymaster gas payment.</p>
<p>This function handles the complexity of using ERC-20 tokens to pay for
gas fees with Pimlico's ERC-20 paymaster:</p>
<ol>
<li>Gets token quotes from Pimlico</li>
<li>Injects a dummy approval for accurate gas estimation</li>
<li>Calculates the maximum cost in tokens</li>
<li>Checks existing allowance and injects approval if needed</li>
<li>Handles USDT special case (requires 0 approval first)</li>
<li>Re-calculates paymaster data with final calls</li>
</ol>
<p><strong>Example:</strong></p>
<pre class="language-dart"><code class="language-dart">final result = await prepareUserOperationForErc20Paymaster(
  smartAccountClient: client,
  pimlicoClient: pimlico,
  publicClient: public,
  token: usdcAddress,
  calls: [transferCall],
  maxFeePerGas: feeData.maxFeePerGas,
  maxPriorityFeePerGas: feeData.maxPriorityFeePerGas,
);

// Sign and send the prepared operation
final signedOp = await client.signUserOperation(result.userOperation);
final hash = await client.sendPreparedUserOperation(signedOp);

print('Max cost: ${result.maxCostInToken} tokens');
print('Approval injected: ${result.approvalInjected}');
</code></pre>
<p><strong>Warning:</strong> This is experimental and the API may change.</p>
</section>


    
<section class="summary source-code" id="source">
  <h2><span>Implementation</span></h2>
  <pre class="language-dart"><code class="language-dart">Future&lt;Erc20PaymasterResult&gt; prepareUserOperationForErc20Paymaster({
  required SmartAccountClient smartAccountClient,
  required PimlicoClient pimlicoClient,
  required PublicClient publicClient,
  required EthereumAddress token,
  required List&lt;Call&gt; calls,
  required BigInt maxFeePerGas,
  required BigInt maxPriorityFeePerGas,
  BigInt? nonce,
  Erc20PaymasterConfig config = const Erc20PaymasterConfig(),
}) async {
  &#47;&#47; 1. Get token quotes
  final quotes = await pimlicoClient.getTokenQuotes([token]);
  if (quotes.isEmpty) {
    throw ArgumentError(
      &#39;Token $token is not supported by the Pimlico ERC-20 paymaster&#39;,
    );
  }

  final quote = quotes.first;
  final paymasterAddress = quote.paymaster;

  &#47;&#47; 2. Create calls with dummy max approval for accurate gas estimation
  final accountAddress = await smartAccountClient.account.getAddress();
  final callsWithDummyApproval = [
    &#47;&#47; Dummy max approval to ensure simulation passes
    encodeErc20Approve(
      token: token,
      spender: paymasterAddress,
      amount: maxUint256,
    ),
    ...calls,
  ];

  &#47;&#47; Handle USDT special case (requires reset to 0 first)
  final isMainnetUsdt =
      token.hex.toLowerCase() == _mainnetUsdtAddress.hex.toLowerCase();
  if (isMainnetUsdt) {
    callsWithDummyApproval.insert(
      0,
      encodeErc20Approve(
        token: _mainnetUsdtAddress,
        spender: paymasterAddress,
        amount: BigInt.zero,
      ),
    );
  }

  &#47;&#47; 3. Build state override if balance override is configured
  List&lt;StateOverride&gt;? stateOverride;
  if (config.balanceOverride) {
    final balanceSlot = config.balanceSlot ?? quote.balanceSlot;
    if (balanceSlot == null) {
      throw ArgumentError(
        &#39;Balance override requested but no balance slot available for $token. &#39;
        &#39;Provide a custom balanceSlot in the config.&#39;,
      );
    }
    stateOverride = erc20BalanceOverride(
      token: token,
      owner: accountAddress,
      slot: balanceSlot,
    );
  }

  &#47;&#47; 4. Prepare initial UserOperation with dummy approval
  final paymasterContext = PaymasterContext(token: token);

  final initialUserOp = await smartAccountClient.prepareUserOperation(
    calls: callsWithDummyApproval,
    maxFeePerGas: maxFeePerGas,
    maxPriorityFeePerGas: maxPriorityFeePerGas,
    nonce: nonce,
    paymasterContext: paymasterContext,
    stateOverride: stateOverride,
  );

  &#47;&#47; 5. Calculate maximum cost in tokens
  final userOperationMaxGas = initialUserOp.preVerificationGas +
      initialUserOp.callGasLimit +
      initialUserOp.verificationGasLimit +
      (initialUserOp.paymasterPostOpGasLimit ?? BigInt.zero) +
      (initialUserOp.paymasterVerificationGasLimit ?? BigInt.zero);

  final userOperationMaxCost = userOperationMaxGas * initialUserOp.maxFeePerGas;

  &#47;&#47; Formula from Pimlico&#39;s singleton paymaster:
  &#47;&#47; maxCostInToken = ((userOpMaxCost + postOpGas * maxFeePerGas) * exchangeRate) &#47; 1e18
  final maxCostInToken =
      ((userOperationMaxCost + quote.postOpGas * initialUserOp.maxFeePerGas) *
              quote.exchangeRate) ~&#47;
          BigInt.from(10).pow(18);

  &#47;&#47; 6. Check existing allowance
  final allowanceCallData = encodeErc20AllowanceCall(
    owner: accountAddress,
    spender: paymasterAddress,
  );

  final allowanceResult = await publicClient.call(
    Call(to: token, data: allowanceCallData),
  );
  final currentAllowance = decodeUint256Result(allowanceResult);

  &#47;&#47; 7. Build final calls with approval if needed
  final hasSufficientApproval = currentAllowance &gt;= maxCostInToken;
  final finalCalls = List&lt;Call&gt;.from(calls);
  var approvalInjected = false;

  if (!hasSufficientApproval) {
    approvalInjected = true;

    &#47;&#47; Add approval for exact max cost (not unlimited for security)
    finalCalls.insert(
      0,
      encodeErc20Approve(
        token: token,
        spender: paymasterAddress,
        amount: maxCostInToken,
      ),
    );

    &#47;&#47; Handle USDT special case
    if (isMainnetUsdt) {
      finalCalls.insert(
        0,
        encodeErc20Approve(
          token: _mainnetUsdtAddress,
          spender: paymasterAddress,
          amount: BigInt.zero,
        ),
      );
    }
  }

  &#47;&#47; 8. Re-encode call data with final calls
  final finalCallData = smartAccountClient.account.encodeCalls(finalCalls);

  &#47;&#47; 9. Get final paymaster data
  final paymaster = smartAccountClient.paymaster;
  if (paymaster == null) {
    throw StateError(
      &#39;SmartAccountClient must have a paymaster configured to use ERC-20 paymaster&#39;,
    );
  }

  final finalPaymasterData = await paymaster.getPaymasterData(
    userOp: UserOperationV07(
      sender: initialUserOp.sender,
      nonce: initialUserOp.nonce,
      factory: initialUserOp.factory,
      factoryData: initialUserOp.factoryData,
      callData: finalCallData,
      callGasLimit: initialUserOp.callGasLimit,
      verificationGasLimit: initialUserOp.verificationGasLimit,
      preVerificationGas: initialUserOp.preVerificationGas,
      maxFeePerGas: initialUserOp.maxFeePerGas,
      maxPriorityFeePerGas: initialUserOp.maxPriorityFeePerGas,
      signature: initialUserOp.signature,
    ),
    entryPoint: smartAccountClient.account.entryPoint,
    chainId: smartAccountClient.account.chainId,
    context: paymasterContext,
  );

  &#47;&#47; 10. Build final UserOperation
  final finalUserOp = UserOperationV07(
    sender: initialUserOp.sender,
    nonce: initialUserOp.nonce,
    factory: initialUserOp.factory,
    factoryData: initialUserOp.factoryData,
    callData: finalCallData,
    callGasLimit: initialUserOp.callGasLimit,
    verificationGasLimit: initialUserOp.verificationGasLimit,
    preVerificationGas: initialUserOp.preVerificationGas,
    maxFeePerGas: initialUserOp.maxFeePerGas,
    maxPriorityFeePerGas: initialUserOp.maxPriorityFeePerGas,
    paymaster: finalPaymasterData.paymaster,
    paymasterVerificationGasLimit:
        finalPaymasterData.paymasterVerificationGasLimit,
    paymasterPostOpGasLimit: finalPaymasterData.paymasterPostOpGasLimit,
    paymasterData: finalPaymasterData.paymasterData,
    signature: smartAccountClient.account.getStubSignature(),
  );

  return Erc20PaymasterResult(
    userOperation: finalUserOp,
    tokenQuote: quote,
    maxCostInToken: maxCostInToken,
    approvalInjected: approvalInjected,
  );
}</code></pre>
</section>


  </div> <!-- /.main-content -->
  <div id="dartdoc-sidebar-left" class="sidebar sidebar-offcanvas-left">
    <!-- The search input and breadcrumbs below are only responsively visible at low resolutions. -->
<header id="header-search-sidebar" class="hidden-l">
  <form class="search-sidebar" role="search">
    <input type="text" id="search-sidebar" autocomplete="off" disabled class="form-control typeahead" placeholder="Loading search...">
  </form>
</header>
<ol class="breadcrumbs gt-separated dark hidden-l" id="sidebar-nav">
    <li><a href="../index.html">permissionless</a></li>
    <li><a href="../permissionless/">permissionless</a></li>
    <li class="self-crumb">prepareUserOperationForErc20Paymaster function</li>
</ol>

    <h5>permissionless library</h5>
    <div id="dartdoc-sidebar-left-content"></div>
  </div><!--/.sidebar-offcanvas-left-->
  <div id="dartdoc-sidebar-right" class="sidebar sidebar-offcanvas-right">
  </div><!--/.sidebar-offcanvas-->
</main>
<footer>
  <span class="no-break">
    permissionless
      0.1.1
  </span>
  
</footer>


<script src="../static-assets/highlight.pack.js?v1"></script>
<script src="../static-assets/docs.dart.js"></script>

</body>
</html>

